# DeployAll Pipeline - å…¨æ ˆéƒ¨ç½²æµæ°´çº¿

## æ¦‚è¿°

`DeployAll.Jenkinsfile` æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Jenkins æµæ°´çº¿ï¼Œç”¨äºä¸€æ¬¡æ€§éƒ¨ç½²æ‰€æœ‰åŸºç¡€è®¾æ–½ç»„ä»¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ æ”¯æŒçš„éƒ¨ç½²ç»„ä»¶

- **Kubernetes** - å®¹å™¨ç¼–æ’å¹³å°
- **Prometheus** - ç›‘æ§ç³»ç»Ÿï¼ˆå« Node Exporterï¼‰
- **Grafana** - å¯è§†åŒ–ä»ªè¡¨æ¿
- **GitLab** - ä»£ç ä»“åº“
- **Jenkins** - CI/CD å¹³å°
- **Redis** - ç¼“å­˜é›†ç¾¤
- **MySQL** - å…³ç³»å‹æ•°æ®åº“
- **MongoDB** - æ–‡æ¡£æ•°æ®åº“
- **ElasticSearch** - æœç´¢å¼•æ“
- **Kafka** - æ¶ˆæ¯é˜Ÿåˆ—

### âš™ï¸ éƒ¨ç½²æ¨¡å¼

#### 1. é¡ºåºéƒ¨ç½² (Sequential)
- æŒ‰ç…§é¢„å®šä¹‰é¡ºåºä¾æ¬¡éƒ¨ç½²
- é€‚åˆæœ‰ä¾èµ–å…³ç³»çš„ç»„ä»¶
- ä¾¿äºæ’æŸ¥é—®é¢˜
- æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ

#### 2. å¹¶è¡Œéƒ¨ç½² (Parallel)
- å¤šä¸ªç»„ä»¶åŒæ—¶éƒ¨ç½²
- å¤§å¹…ç¼©çŸ­æ€»éƒ¨ç½²æ—¶é—´
- é€‚åˆç‹¬ç«‹ç»„ä»¶
- æ¨èç”¨äºæµ‹è¯•ç¯å¢ƒ

### ğŸ“‹ å¯é…ç½®å‚æ•°

| å‚æ•°åç§° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|------|--------|------|
| DEPLOY_KUBERNETES | Boolean | true | æ˜¯å¦éƒ¨ç½² Kubernetes |
| DEPLOY_PROMETHEUS | Boolean | true | æ˜¯å¦éƒ¨ç½² Prometheus |
| DEPLOY_GRAFANA | Boolean | true | æ˜¯å¦éƒ¨ç½² Grafana |
| DEPLOY_GITLAB | Boolean | true | æ˜¯å¦éƒ¨ç½² GitLab |
| DEPLOY_JENKINS | Boolean | true | æ˜¯å¦éƒ¨ç½² Jenkins |
| DEPLOY_REDIS | Boolean | true | æ˜¯å¦éƒ¨ç½² Redis |
| DEPLOY_MYSQL | Boolean | true | æ˜¯å¦éƒ¨ç½² MySQL |
| DEPLOY_MONGODB | Boolean | true | æ˜¯å¦éƒ¨ç½² MongoDB |
| DEPLOY_ELASTICSEARCH | Boolean | true | æ˜¯å¦éƒ¨ç½² ElasticSearch |
| DEPLOY_KAFKA | Boolean | true | æ˜¯å¦éƒ¨ç½² Kafka |
| DEPLOYMENT_MODE | Choice | sequential | éƒ¨ç½²æ¨¡å¼ (sequential/parallel) |
| REQUIRE_APPROVAL | Boolean | true | æ¯ä¸ªç»„ä»¶éƒ¨ç½²å‰æ˜¯å¦éœ€è¦æ‰‹åŠ¨æ‰¹å‡† |

### ğŸš¦ æ‰¹å‡†é—¨æ§ (Approval Gateway)

æ¯ä¸ªç»„ä»¶éƒ¨ç½²å‰ä¼šæš‚åœå¹¶ç­‰å¾…æ‰‹åŠ¨æ‰¹å‡†ï¼š

- **å¯ç”¨æ‰¹å‡†**: `REQUIRE_APPROVAL = true` (é»˜è®¤)
- **ç¦ç”¨æ‰¹å‡†**: `REQUIRE_APPROVAL = false` (è‡ªåŠ¨éƒ¨ç½²)

#### æ‰¹å‡†æµç¨‹

1. æµæ°´çº¿æ‰§è¡Œåˆ°æŸä¸ªç»„ä»¶æ—¶ä¼šæš‚åœ
2. Jenkins UI æ˜¾ç¤ºæ‰¹å‡†æç¤ºæ¡†
3. ç®¡ç†å‘˜ç‚¹å‡»"æ‰¹å‡†éƒ¨ç½²"æˆ–"ä¸­æ­¢"
4. å¯é€‰å¡«å†™æ‰¹å‡†å¤‡æ³¨è¯´æ˜
5. æ‰¹å‡†åç»§ç»­æ‰§è¡Œè¯¥ç»„ä»¶éƒ¨ç½²

#### æ‰¹å‡†ç•Œé¢ç¤ºä¾‹

```
â¸ï¸  ç­‰å¾…æ‰¹å‡†éƒ¨ç½²: Kubernetes é›†ç¾¤

æ˜¯å¦ç»§ç»­éƒ¨ç½² Kubernetes é›†ç¾¤ï¼Ÿ

æ‰¹å‡†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰: 
[                                    ]

[æ‰¹å‡†éƒ¨ç½²]  [ä¸­æ­¢]

æäº¤è€…é™åˆ¶: admin
```

#### æ‰¹å‡†æƒé™

- é»˜è®¤åªæœ‰ `admin` ç”¨æˆ·å¯ä»¥æ‰¹å‡†
- å¯ä»¥åœ¨ `requestApproval` å‡½æ•°ä¸­ä¿®æ”¹ `submitter` å‚æ•°
- æ”¯æŒå¤šä¸ªæ‰¹å‡†è€…: `submitter: 'admin,deploy-team'`

## ä½¿ç”¨æ–¹æ³•

### åœ¨ Jenkins ä¸­åˆ›å»ºæµæ°´çº¿

1. è®¿é—® Jenkins: http://192.168.31.70:8080
2. ç‚¹å‡» **New Item**
3. è¾“å…¥åç§°: `deploy-all-infrastructure`
4. é€‰æ‹© **Pipeline**
5. ç‚¹å‡» **OK**

### é…ç½®æµæ°´çº¿

åœ¨ Pipeline é…ç½®éƒ¨åˆ†:

1. **Definition**: é€‰æ‹© `Pipeline script from SCM`
2. **SCM**: é€‰æ‹© `Git`
3. **Repository URL**: `git@192.168.31.50:gaamingzhang/ansible.git`
4. **Credentials**: é€‰æ‹© `gitlab-ssh-key`
5. **Branch**: `*/main`
6. **Script Path**: `pipelines/DeployAll.Jenkinsfile`
7. ç‚¹å‡» **Save**

### æ‰§è¡Œéƒ¨ç½²

#### æ–¹å¼ 1: å…¨é‡éƒ¨ç½²ï¼ˆå¸¦æ‰¹å‡†ï¼‰

1. è®¿é—®æµæ°´çº¿: http://192.168.31.70:8080/job/deploy-all-infrastructure/
2. ç‚¹å‡» **Build with Parameters**
3. ä¿æŒæ‰€æœ‰é€‰é¡¹ä¸ºé»˜è®¤å€¼ï¼ˆå…¨éƒ¨å‹¾é€‰ï¼‰
4. âœ“ **REQUIRE_APPROVAL**: true (éœ€è¦æ‰‹åŠ¨æ‰¹å‡†)
5. é€‰æ‹©éƒ¨ç½²æ¨¡å¼: `sequential` æˆ– `parallel`
6. ç‚¹å‡» **Build**
7. åœ¨ Console Output ä¸­ç­‰å¾…æ‰¹å‡†æç¤º
8. ç‚¹å‡»ç•Œé¢ä¸Šçš„"æ‰¹å‡†éƒ¨ç½²"æŒ‰é’®é€ä¸ªæ‰¹å‡†ç»„ä»¶

#### æ–¹å¼ 2: è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ— éœ€æ‰¹å‡†ï¼‰

1. ç‚¹å‡» **Build with Parameters**
2. âœ— **REQUIRE_APPROVAL**: false (å…³é—­æ‰¹å‡†é—¨æ§)
3. ä¿æŒå…¶ä»–é€‰é¡¹ä¸ºé»˜è®¤å€¼
4. ç‚¹å‡» **Build**
5. æµæ°´çº¿å°†è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰éƒ¨ç½²ï¼Œæ— éœ€äººå·¥å¹²é¢„

#### æ–¹å¼ 3: é€‰æ‹©æ€§éƒ¨ç½²

1. ç‚¹å‡» **Build with Parameters**
2. å–æ¶ˆä¸éœ€è¦éƒ¨ç½²çš„ç»„ä»¶
3. ä¾‹å¦‚ï¼šåªéƒ¨ç½²ç›‘æ§æ ˆï¼ˆPrometheus + Grafanaï¼‰
   - âœ“ DEPLOY_PROMETHEUS
   - âœ“ DEPLOY_GRAFANA
   - âœ— å…¶ä»–ç»„ä»¶å…¨éƒ¨å–æ¶ˆ
4. âœ“ **REQUIRE_APPROVAL**: true (ä¿æŒéœ€è¦æ‰¹å‡†)
5. ç‚¹å‡» **Build**
6. åªéœ€æ‰¹å‡† Prometheus å’Œ Grafana ä¸¤ä¸ªç»„ä»¶

#### æ–¹å¼ 4: API è§¦å‘

```bash
# å…¨é‡éƒ¨ç½²ï¼ˆéœ€è¦æ‰¹å‡†ï¼‰
curl -X POST "http://192.168.31.70:8080/job/deploy-all-infrastructure/buildWithParameters" \
  --user admin:your-token \
  --data "DEPLOYMENT_MODE=sequential" \
  --data "REQUIRE_APPROVAL=true"

# è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ— éœ€æ‰¹å‡†ï¼‰
curl -X POST "http://192.168.31.70:8080/job/deploy-all-infrastructure/buildWithParameters" \
  --user admin:your-token \
  --data "DEPLOYMENT_MODE=parallel" \
  --data "REQUIRE_APPROVAL=false"

# åªéƒ¨ç½²ç‰¹å®šç»„ä»¶
curl -X POST "http://192.168.31.70:8080/job/deploy-all-infrastructure/buildWithParameters" \
  --user admin:your-token \
  --data "DEPLOY_KUBERNETES=true" \
  --data "DEPLOY_PROMETHEUS=true" \
  --data "DEPLOY_GRAFANA=false" \
  --data "REQUIRE_APPROVAL=true" \
  --data "DEPLOYMENT_MODE=parallel"
```

## æ‰¹å‡†é—¨æ§ä½¿ç”¨è¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦æ‰¹å‡†é—¨æ§ï¼Ÿ

1. âœ… **å®‰å…¨æ§åˆ¶**: é˜²æ­¢è¯¯æ“ä½œå¯¼è‡´çš„æ„å¤–éƒ¨ç½²
2. âœ… **å®¡è®¡è¿½è¸ª**: è®°å½•è°åœ¨ä½•æ—¶æ‰¹å‡†äº†å“ªä¸ªéƒ¨ç½²
3. âœ… **çµæ´»æ§åˆ¶**: å¯ä»¥åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­æ£€æŸ¥ä¸Šä¸€ä¸ªç»„ä»¶çŠ¶æ€
4. âœ… **åˆ†é˜¶æ®µéƒ¨ç½²**: å…è®¸åœ¨ä¸åŒæ—¶é—´éƒ¨ç½²ä¸åŒç»„ä»¶
5. âœ… **é£é™©é™ä½**: ç»™äºˆç®¡ç†å‘˜æœ€åä¸€æ¬¡ç¡®è®¤çš„æœºä¼š

### æ‰¹å‡†æœ€ä½³å®è·µ

#### 1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```
æ¨èé…ç½®:
- REQUIRE_APPROVAL: true
- DEPLOYMENT_MODE: sequential
- æ‰¹å‡†å‰æ£€æŸ¥: ä¸Šä¸€ä¸ªç»„ä»¶çš„å¥åº·çŠ¶æ€
```

#### 2. æµ‹è¯•ç¯å¢ƒéƒ¨ç½²
```
æ¨èé…ç½®:
- REQUIRE_APPROVAL: false
- DEPLOYMENT_MODE: parallel
- å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œå¿«é€Ÿè¿­ä»£
```

#### 3. é¦–æ¬¡éƒ¨ç½²
```
æ¨èé…ç½®:
- REQUIRE_APPROVAL: true
- DEPLOYMENT_MODE: sequential
- é€æ­¥éªŒè¯æ¯ä¸ªç»„ä»¶
```

### æ‰¹å‡†æ“ä½œæ­¥éª¤

1. **å¯åŠ¨æ„å»º**
   ```
   Build with Parameters
   âœ“ REQUIRE_APPROVAL: true
   ```

2. **ç›‘æ§è¿›åº¦**
   ```
   è®¿é—®: http://192.168.31.70:8080/job/deploy-all-infrastructure/lastBuild/
   æŸ¥çœ‹ Console Output
   ```

3. **ç­‰å¾…æ‰¹å‡†æç¤º**
   ```
   [Pipeline] input
   â¸ï¸  ç­‰å¾…æ‰¹å‡†éƒ¨ç½²: Kubernetes é›†ç¾¤
   Paused for Input
   ```

4. **ç‚¹å‡»æ‰¹å‡†**
   - åœ¨ Console Output é¡µé¢ï¼Œä¼šå‡ºç°è“è‰²çš„"Proceed"æˆ–"Abort"æŒ‰é’®
   - æˆ–åœ¨ Build é¡µé¢å·¦ä¾§èœå•ç‚¹å‡»"Paused for Input"
   - å¡«å†™æ‰¹å‡†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
   - ç‚¹å‡»"æ‰¹å‡†éƒ¨ç½²"

5. **ç»§ç»­æ‰§è¡Œ**
   ```
   âœ… å·²æ‰¹å‡†éƒ¨ç½²: Kubernetes é›†ç¾¤
   â†’ å¼€å§‹éƒ¨ç½²: Kubernetes é›†ç¾¤
   ```

### æ‰¹å‡†è¶…æ—¶è®¾ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰¹å‡†è¯·æ±‚ä¼šæ— é™æœŸç­‰å¾…ã€‚å¯ä»¥æ·»åŠ è¶…æ—¶é™åˆ¶ï¼š

```groovy
// ä¿®æ”¹ requestApproval å‡½æ•°
timeout(time: 30, unit: 'MINUTES') {
    input(
        message: "æ˜¯å¦ç»§ç»­éƒ¨ç½² ${componentName}ï¼Ÿ",
        ok: "æ‰¹å‡†éƒ¨ç½²"
    )
}
```

### å¹¶è¡Œæ¨¡å¼ä¸‹çš„æ‰¹å‡†å’Œéƒ¨ç½²

âœ… **æ–°ç‰¹æ€§**: å¹¶è¡Œéƒ¨ç½²æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªç»„ä»¶å®Œå…¨ç‹¬ç«‹ï¼š

```
æµç¨‹:
1. æ‰€æœ‰ç»„ä»¶åŒæ—¶å¯åŠ¨
2. æ¯ä¸ªç»„ä»¶ç‹¬ç«‹ç­‰å¾…æ‰¹å‡†
3. æ‰¹å‡†åç«‹å³å¼€å§‹éƒ¨ç½²è¯¥ç»„ä»¶
4. å…¶ä»–ç»„ä»¶ä¸å—å½±å“

ç¤ºä¾‹:
â”œâ”€ [Kubernetes]    â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â”œâ”€ [Prometheus]    â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â”œâ”€ [Grafana]       â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â””â”€ [Redis]         â¸ï¸  ç­‰å¾…æ‰¹å‡†...

æ‰¹å‡† Grafana å:
â”œâ”€ [Kubernetes]    â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â”œâ”€ [Prometheus]    â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â”œâ”€ [Grafana]       ğŸš€ éƒ¨ç½²ä¸­... â†’ âœ… å®Œæˆ
â””â”€ [Redis]         â¸ï¸  ç­‰å¾…æ‰¹å‡†...

æ‹’ç» Kubernetes:
â”œâ”€ [Kubernetes]    âŒ å·²æ‹’ç»ï¼ˆä¸å½±å“å…¶ä»–ç»„ä»¶ï¼‰
â”œâ”€ [Prometheus]    â¸ï¸  ç­‰å¾…æ‰¹å‡†...
â”œâ”€ [Grafana]       âœ… å·²å®Œæˆ
â””â”€ [Redis]         ğŸš€ éƒ¨ç½²ä¸­...
```

**å…³é”®ä¼˜åŠ¿**:
- âœ… æ¯ä¸ªç»„ä»¶ç‹¬ç«‹æ‰¹å‡†å’Œéƒ¨ç½²
- âœ… æ‹’ç»æˆ–å¤±è´¥ä¸å½±å“å…¶ä»–ç»„ä»¶
- âœ… å¯ä»¥å…ˆæ‰¹å‡†å¿«é€Ÿéƒ¨ç½²çš„ç»„ä»¶
- âœ… çµæ´»æ§åˆ¶éƒ¨ç½²èŠ‚å¥

**é¡ºåºæ¨¡å¼**: ç»„ä»¶ä¾æ¬¡æ‰§è¡Œï¼Œä¸€ä¸ªå¤±è´¥ä¼šä¸­æ­¢åç»­æ‰€æœ‰ç»„ä»¶ã€‚

## æµæ°´çº¿é˜¶æ®µè¯´æ˜

### 1. å‡†å¤‡é˜¶æ®µ
- æ˜¾ç¤ºé…ç½®ä¿¡æ¯
- ç¡®è®¤éƒ¨ç½²å‚æ•°

### 2. è¿æ¥æµ‹è¯•
- æµ‹è¯• SSH è¿æ¥åˆ° Ansible æ§åˆ¶èŠ‚ç‚¹
- éªŒè¯ Ansible ç‰ˆæœ¬
- æ£€æŸ¥é¡¹ç›®ç›®å½•

### 3. æ›´æ–°ä»£ç 
- ä» GitLab æ‹‰å–æœ€æ–°ä»£ç 
- æ˜¾ç¤ºå½“å‰åˆ†æ”¯å’Œæœ€æ–°æäº¤

### 4. éƒ¨ç½²åŸºç¡€è®¾æ–½
- æ ¹æ®å‚æ•°é€‰æ‹©éƒ¨ç½²ç»„ä»¶
- æ ¹æ®æ¨¡å¼é€‰æ‹©é¡ºåºæˆ–å¹¶è¡Œæ‰§è¡Œ
- å®æ—¶æ˜¾ç¤ºéƒ¨ç½²è¿›åº¦

### 5. éªŒè¯éƒ¨ç½²
- ä½¿ç”¨ `ansible ping` éªŒè¯æ‰€æœ‰ä¸»æœºè¿é€šæ€§
- ç¡®è®¤éƒ¨ç½²æˆåŠŸ

## æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è§¦å‘éƒ¨ç½²                                                â”‚
â”‚  Jenkins Web UI / API / Webhook                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Jenkins æœåŠ¡å™¨ (192.168.31.70)                             â”‚
â”‚  - è¯»å– DeployAll.Jenkinsfile                               â”‚
â”‚  - è§£æå‚æ•°å’Œé…ç½®                                            â”‚
â”‚  - å‡†å¤‡ SSH å‡­æ®                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ SSH with Credentials
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ansible æ§åˆ¶èŠ‚ç‚¹ (192.168.31.10)                           â”‚
â”‚  - æ‹‰å–æœ€æ–°ä»£ç                                               â”‚
â”‚  - æ‰§è¡Œ ansible-playbook å‘½ä»¤                               â”‚
â”‚  - å¹¶è¡Œ/é¡ºåºéƒ¨ç½²ç»„ä»¶                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ SSH to target hosts
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›®æ ‡æœåŠ¡å™¨ç¾¤                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Kubernetes   â”‚ Monitoring   â”‚ Databases    â”‚            â”‚
â”‚  â”‚ K8s Masters  â”‚ Prometheus   â”‚ MySQL        â”‚            â”‚
â”‚  â”‚ K8s Workers  â”‚ Grafana      â”‚ MongoDB      â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ DevOps       â”‚ Cache        â”‚ Messaging    â”‚            â”‚
â”‚  â”‚ GitLab       â”‚ Redis        â”‚ Kafka        â”‚            â”‚
â”‚  â”‚ Jenkins      â”‚              â”‚ ElasticSearchâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éƒ¨ç½²æ—¶é—´ä¼°ç®—

### é¡ºåºéƒ¨ç½²æ¨¡å¼

| ç»„ä»¶ | é¢„ä¼°æ—¶é—´ |
|------|---------|
| Kubernetes | 15-20 åˆ†é’Ÿ |
| Prometheus | 5-8 åˆ†é’Ÿ |
| Grafana | 3-5 åˆ†é’Ÿ |
| GitLab | 8-10 åˆ†é’Ÿ |
| Jenkins | 5-7 åˆ†é’Ÿ |
| Redis | 5-8 åˆ†é’Ÿ |
| MySQL | 4-6 åˆ†é’Ÿ |
| MongoDB | 4-6 åˆ†é’Ÿ |
| ElasticSearch | 6-8 åˆ†é’Ÿ |
| Kafka | 5-7 åˆ†é’Ÿ |
| **æ€»è®¡** | **60-85 åˆ†é’Ÿ** |

### å¹¶è¡Œéƒ¨ç½²æ¨¡å¼

- **æ€»æ—¶é—´**: çº¦ 20-25 åˆ†é’Ÿ
- **åŠ é€Ÿæ¯”**: çº¦ 3-4 å€
- **æ³¨æ„**: éœ€è¦è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æº

## æ—¥å¿—ç¤ºä¾‹

### é¡ºåºéƒ¨ç½²è¾“å‡ºï¼ˆå¸¦æ‰¹å‡†ï¼‰

```
==========================================
å…¨æ ˆåŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–éƒ¨ç½²
==========================================
Ansible æ§åˆ¶èŠ‚ç‚¹: 192.168.31.10
éƒ¨ç½²ç”¨æˆ·: node
é¡¹ç›®ç›®å½•: /home/node/ansible
éƒ¨ç½²æ¨¡å¼: sequential
==========================================

[è¿æ¥æµ‹è¯•] âœ“ æˆåŠŸè¿æ¥åˆ° Ansible æ§åˆ¶èŠ‚ç‚¹
ä¸»æœºå: AnsibleControlNode
Ansible ç‰ˆæœ¬: 2.14.0

[æ›´æ–°ä»£ç ] æ‹‰å–æœ€æ–°ä»£ç ...
Already up to date.

[éƒ¨ç½² Kubernetes] 
â¸ï¸  ç­‰å¾…æ‰¹å‡†éƒ¨ç½²: Kubernetes é›†ç¾¤

Input requested
Proceed or Abort
[æ‰¹å‡†å¤‡æ³¨]: å¼€å§‹éƒ¨ç½² K8s é›†ç¾¤

âœ… å·²æ‰¹å‡†éƒ¨ç½²: Kubernetes é›†ç¾¤
================================================
éƒ¨ç½²: Kubernetes é›†ç¾¤
Playbook: playbook/kubernetes/deploy-k8s-cluster.yml
================================================
PLAY [éƒ¨ç½² Kubernetes é›†ç¾¤] **********************
...
âœ“ Kubernetes é›†ç¾¤ éƒ¨ç½²å®Œæˆ

[éƒ¨ç½² Prometheus]
â¸ï¸  ç­‰å¾…æ‰¹å‡†éƒ¨ç½²: Prometheus ç›‘æ§

Input requested
Proceed or Abort

âœ… å·²æ‰¹å‡†éƒ¨ç½²: Prometheus ç›‘æ§
================================================
éƒ¨ç½²: Prometheus ç›‘æ§
Playbook: playbook/Prometheus/deploy-prometheus.yml
================================================
...
âœ“ Prometheus ç›‘æ§ éƒ¨ç½²å®Œæˆ

...

==========================================
âœ… æ‰€æœ‰ç»„ä»¶éƒ¨ç½²æˆåŠŸï¼
==========================================
å·²éƒ¨ç½²ç»„ä»¶: Kubernetes, Prometheus, Grafana, ...
```

### è‡ªåŠ¨éƒ¨ç½²è¾“å‡ºï¼ˆæ— æ‰¹å‡†ï¼‰

```
==========================================
å…¨æ ˆåŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–éƒ¨ç½²
==========================================
Ansible æ§åˆ¶èŠ‚ç‚¹: 192.168.31.10
éƒ¨ç½²ç”¨æˆ·: node
é¡¹ç›®ç›®å½•: /home/node/ansible
éƒ¨ç½²æ¨¡å¼: sequential
==========================================

[è¿æ¥æµ‹è¯•] âœ“ æˆåŠŸè¿æ¥åˆ° Ansible æ§åˆ¶èŠ‚ç‚¹
ä¸»æœºå: AnsibleControlNode
Ansible ç‰ˆæœ¬: 2.14.0

[æ›´æ–°ä»£ç ] æ‹‰å–æœ€æ–°ä»£ç ...
Already up to date.

[éƒ¨ç½² Kubernetes] 
================================================
éƒ¨ç½²: Kubernetes é›†ç¾¤
Playbook: playbook/kubernetes/deploy-k8s-cluster.yml
================================================
PLAY [éƒ¨ç½² Kubernetes é›†ç¾¤] **********************
...
âœ“ Kubernetes é›†ç¾¤ éƒ¨ç½²å®Œæˆ

[éƒ¨ç½² Prometheus]
================================================
éƒ¨ç½²: Prometheus ç›‘æ§
Playbook: playbook/Prometheus/deploy-prometheus.yml
================================================
...
âœ“ Prometheus ç›‘æ§ éƒ¨ç½²å®Œæˆ

...

==========================================
âœ… æ‰€æœ‰ç»„ä»¶éƒ¨ç½²æˆåŠŸï¼
==========================================
å·²éƒ¨ç½²ç»„ä»¶: Kubernetes, Prometheus, Grafana, ...
```

### å¹¶è¡Œéƒ¨ç½²è¾“å‡ºï¼ˆç‹¬ç«‹æ‰¹å‡†ï¼‰

```
ä½¿ç”¨å¹¶è¡Œéƒ¨ç½²æ¨¡å¼...
âœ“ æ¯ä¸ªç»„ä»¶ç‹¬ç«‹æ‰¹å‡†å’Œéƒ¨ç½²ï¼Œäº’ä¸å½±å“

[å¯åŠ¨å¹¶è¡Œæ‰§è¡Œ]
- Kubernetes: ç­‰å¾…æ‰¹å‡†...
- Prometheus: ç­‰å¾…æ‰¹å‡†...
- Grafana: ç­‰å¾…æ‰¹å‡†...
- GitLab: ç­‰å¾…æ‰¹å‡†...
- Redis: ç­‰å¾…æ‰¹å‡†...
- MySQL: ç­‰å¾…æ‰¹å‡†...

[æ‰¹å‡† Grafana]
Input requested for Grafana
âœ… å·²æ‰¹å‡†éƒ¨ç½²: Grafana
â†’ å¼€å§‹éƒ¨ç½²: Grafana
...
âœ“ Grafana éƒ¨ç½²å®Œæˆ (3m 42s)

[æ‰¹å‡† Redis]
Input requested for Redis
âœ… å·²æ‰¹å‡†éƒ¨ç½²: Redis
â†’ å¼€å§‹éƒ¨ç½²: Redis
...
âœ“ Redis éƒ¨ç½²å®Œæˆ (5m 18s)

[æ‹’ç» Kubernetes]
Input requested for Kubernetes
âŒ Kubernetes éƒ¨ç½²å¤±è´¥æˆ–è¢«ä¸­æ­¢: User abort

[æ‰¹å‡† Prometheus]
Input requested for Prometheus
âœ… å·²æ‰¹å‡†éƒ¨ç½²: Prometheus
â†’ å¼€å§‹éƒ¨ç½²: Prometheus
...
âœ“ Prometheus éƒ¨ç½²å®Œæˆ (7m 05s)

[æ‰¹å‡†å‰©ä½™ç»„ä»¶...]
...

==========================================
âš ï¸  éƒ¨åˆ†ç»„ä»¶éƒ¨ç½²å¤±è´¥æˆ–è¢«ä¸­æ­¢
==========================================
è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—ï¼Œæ£€æŸ¥å“ªäº›ç»„ä»¶éƒ¨ç½²å¤±è´¥
æˆåŠŸçš„ç»„ä»¶ä¸å—å½±å“

å·²éƒ¨ç½²ç»„ä»¶: Prometheus, Grafana, Redis, MySQL, ...
æ‹’ç»/å¤±è´¥: Kubernetes

```

### é¡ºåºéƒ¨ç½²è¾“å‡º

```
ä½¿ç”¨é¡ºåºéƒ¨ç½²æ¨¡å¼...

[Kubernetes] â†’ å¼€å§‹éƒ¨ç½²
[Prometheus] â†’ å¼€å§‹éƒ¨ç½²
[Grafana] â†’ å¼€å§‹éƒ¨ç½²
[GitLab] â†’ å¼€å§‹éƒ¨ç½²
[Redis] â†’ å¼€å§‹éƒ¨ç½²
...

[Grafana] âœ“ éƒ¨ç½²å®Œæˆ (3m 42s)
[Redis] âœ“ éƒ¨ç½²å®Œæˆ (5m 18s)
[Prometheus] âœ“ éƒ¨ç½²å®Œæˆ (7m 05s)
...
[Kubernetes] âœ“ éƒ¨ç½²å®Œæˆ (18m 32s)

æ‰€æœ‰ç»„ä»¶éƒ¨ç½²å®Œæˆï¼Œæ€»è€—æ—¶: 18m 32s
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SSH è¿æ¥å¤±è´¥

**é”™è¯¯**: `Permission denied (publickey)`

**è§£å†³**:
```bash
# åœ¨ Jenkins æœåŠ¡å™¨ä¸Šç¡®è®¤å‡­æ®
ssh node@192.168.31.10 "hostname"

# æ£€æŸ¥ Jenkins å‡­æ®é…ç½®
# http://192.168.31.70:8080/manage/credentials/
```

### é—®é¢˜ 2: Ansible playbook æ‰§è¡Œå¤±è´¥

**é”™è¯¯**: `ansible-playbook: command not found`

**è§£å†³**:
```bash
# åœ¨ Ansible æ§åˆ¶èŠ‚ç‚¹å®‰è£… Ansible
ssh node@192.168.31.10
sudo apt update
sudo apt install -y ansible
```

### é—®é¢˜ 3: éƒ¨ç½²è¶…æ—¶

**é”™è¯¯**: Pipeline é•¿æ—¶é—´æ— å“åº”

**è§£å†³**:
- æ£€æŸ¥ç›®æ ‡ä¸»æœºç½‘ç»œè¿æ¥
- å¢åŠ  Jenkins è¶…æ—¶è®¾ç½®
- ä½¿ç”¨å¹¶è¡Œæ¨¡å¼åŠ é€Ÿ

### é—®é¢˜ 4: å¹¶è¡Œéƒ¨ç½²å†²çª

**é”™è¯¯**: èµ„æºç«äº‰æˆ–ä¾èµ–å†²çª

**è§£å†³**:
- æ”¹ç”¨é¡ºåºéƒ¨ç½²æ¨¡å¼
- åˆ†æ‰¹éƒ¨ç½²æœ‰ä¾èµ–çš„ç»„ä»¶

## æœ€ä½³å®è·µ

### 1. é¦–æ¬¡éƒ¨ç½²

```
æ¨èé¡ºåº:
1. Kubernetes (åŸºç¡€å¹³å°)
2. Prometheus + Node Exporter (ç›‘æ§)
3. Grafana (å¯è§†åŒ–)
4. æ•°æ®åº“å±‚ (MySQL, MongoDB, Redis)
5. åº”ç”¨å±‚ (GitLab, Jenkins)
6. æ¶ˆæ¯é˜Ÿåˆ— (Kafka, ElasticSearch)
```

### 2. æ—¥å¸¸ç»´æŠ¤

- ä½¿ç”¨é€‰æ‹©æ€§éƒ¨ç½²ï¼Œåªæ›´æ–°å˜æ›´çš„ç»„ä»¶
- å®šæœŸæ‰§è¡Œ `ansible ping` éªŒè¯è¿é€šæ€§
- ä¿æŒä»£ç ä»“åº“æœ€æ–°

### 3. å›æ»šç­–ç•¥

```groovy
// åœ¨ playbook ä¸­æ·»åŠ å›æ»šæ”¯æŒ
- name: åˆ›å»ºå¤‡ä»½
  ...
  
- name: éƒ¨ç½²æ–°ç‰ˆæœ¬
  ...
  
- name: éªŒè¯éƒ¨ç½²
  ...
  failed_when: validation_failed
  
- name: å›æ»šåˆ°å¤‡ä»½
  when: validation_failed
  ...
```

### 4. ç›‘æ§éƒ¨ç½²

- æŸ¥çœ‹ Jenkins Console Output
- ç›‘æ§ Ansible æ§åˆ¶èŠ‚ç‚¹èµ„æºä½¿ç”¨
- æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨æ—¥å¿—

## å®‰å…¨å»ºè®®

1. âœ… ä½¿ç”¨ SSH å¯†é’¥è®¤è¯ï¼Œç¦ç”¨å¯†ç ç™»å½•
2. âœ… é™åˆ¶ Jenkins ç”¨æˆ·æƒé™
3. âœ… å®šæœŸè½®æ¢ SSH å¯†é’¥
4. âœ… å¯ç”¨ Jenkins å®¡è®¡æ—¥å¿—
5. âœ… ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
6. âœ… åœ¨ Ansible playbook ä¸­ä½¿ç”¨ vault åŠ å¯†æ•æ„Ÿæ•°æ®

## å¹¶è¡Œéƒ¨ç½²è¯¦ç»†è¯´æ˜

### ç‹¬ç«‹æ€§ä¿éšœ

å¹¶è¡Œæ¨¡å¼é€šè¿‡ä»¥ä¸‹æœºåˆ¶ç¡®ä¿ç»„ä»¶ç‹¬ç«‹ï¼š

1. **ç‹¬ç«‹çš„æ‰¹å‡†æµç¨‹**
   - æ¯ä¸ªç»„ä»¶æœ‰è‡ªå·±çš„ `input` æ­¥éª¤
   - æ‰¹å‡†/æ‹’ç»åªå½±å“è¯¥ç»„ä»¶
   - å¯ä»¥ä»»æ„é¡ºåºæ‰¹å‡†

2. **å¼‚å¸¸éš”ç¦»**
   - æ¯ä¸ªç»„ä»¶åŒ…è£…åœ¨ `try-catch` ä¸­
   - å¤±è´¥ç»„ä»¶æ ‡è®°ä¸º `UNSTABLE`
   - ä¸ä¼šæŠ›å‡ºå¼‚å¸¸å½±å“å…¶ä»–ç»„ä»¶

3. **çŠ¶æ€ç®¡ç†**
   - ä½¿ç”¨ `currentBuild.result = 'UNSTABLE'`
   - æ„å»ºçŠ¶æ€æ˜¾ç¤ºä¸ºé»„è‰²ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰
   - ä¸ä¼šå˜æˆçº¢è‰²ï¼ˆå¤±è´¥ï¼‰å¯¼è‡´ä¸­æ­¢

### å®é™…ä½¿ç”¨ç¤ºä¾‹

#### åœºæ™¯ 1: é€‰æ‹©æ€§éƒ¨ç½²
```
ç›®æ ‡: åªéƒ¨ç½²ç›‘æ§ç›¸å…³ç»„ä»¶

æ“ä½œ:
1. é€‰æ‹© DEPLOY_PROMETHEUS, DEPLOY_GRAFANA
2. é€‰æ‹© DEPLOYMENT_MODE: parallel
3. å¯åŠ¨æ„å»º

ç»“æœ:
- åŒæ—¶æ˜¾ç¤ºä¸¤ä¸ªæ‰¹å‡†æç¤º
- å¯ä»¥å…ˆæ‰¹å‡† Grafanaï¼ˆå¿«é€Ÿéƒ¨ç½²ï¼‰
- å†æ‰¹å‡† Prometheusï¼ˆéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
- ä¸¤è€…å¹¶è¡Œéƒ¨ç½²ï¼Œäº’ä¸ç­‰å¾…
```

#### åœºæ™¯ 2: æ‹’ç»ç‰¹å®šç»„ä»¶
```
ç›®æ ‡: éƒ¨ç½²æ‰€æœ‰ç»„ä»¶ï¼Œä½†è·³è¿‡ GitLab

æ“ä½œ:
1. é€‰æ‹©æ‰€æœ‰ç»„ä»¶
2. é€‰æ‹© DEPLOYMENT_MODE: parallel
3. å¯åŠ¨æ„å»º
4. æ‰¹å‡†å…¶ä»–æ‰€æœ‰ç»„ä»¶
5. æ‹’ç»ï¼ˆAbortï¼‰GitLab

ç»“æœ:
- GitLab è¢«æ ‡è®°ä¸ºä¸­æ­¢
- å…¶ä»–ç»„ä»¶æ­£å¸¸éƒ¨ç½²å®Œæˆ
- æ„å»ºçŠ¶æ€: UNSTABLEï¼ˆé»„è‰²ï¼‰
- å¯ä»¥åç»­å•ç‹¬éƒ¨ç½² GitLab
```

#### åœºæ™¯ 3: éƒ¨åˆ†å¤±è´¥æ¢å¤
```
ç›®æ ‡: æŸäº›ç»„ä»¶å¤±è´¥åç»§ç»­éƒ¨ç½²å…¶ä»–

æ“ä½œ:
1. é€‰æ‹©æ‰€æœ‰ç»„ä»¶å¹¶è¡Œéƒ¨ç½²
2. Kubernetes éƒ¨ç½²å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ï¼‰

ç»“æœ:
- Kubernetes æ ‡è®°ä¸ºå¤±è´¥
- å…¶ä»–ç»„ä»¶ç»§ç»­æ­£å¸¸éƒ¨ç½²
- ä¿®å¤é—®é¢˜åé‡æ–°è¿è¡Œï¼Œåªé€‰æ‹© Kubernetes
- ä¸éœ€è¦é‡æ–°éƒ¨ç½²æˆåŠŸçš„ç»„ä»¶
```

## ä¸ PostCommitDeploy çš„åŒºåˆ«

| ç‰¹æ€§ | DeployAll | PostCommitDeploy |
|------|-----------|------------------|
| è§¦å‘æ–¹å¼ | æ‰‹åŠ¨/å®šæ—¶ | Git æäº¤è‡ªåŠ¨è§¦å‘ |
| éƒ¨ç½²èŒƒå›´ | å¯é€‰æ‹©ä»»æ„ç»„ä»¶ | åªéƒ¨ç½²å˜æ›´çš„ç»„ä»¶ |
| éƒ¨ç½²æ¨¡å¼ | æ”¯æŒå¹¶è¡Œ/é¡ºåº | ä»…é¡ºåºéƒ¨ç½² |
| ç»„ä»¶ç‹¬ç«‹æ€§ | å®Œå…¨ç‹¬ç«‹ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰ | çº¿æ€§ä¾èµ– |
| å¤±è´¥å¤„ç† | éƒ¨åˆ†å¤±è´¥ç»§ç»­æ‰§è¡Œ | å¤±è´¥å³ä¸­æ­¢ |
| ä½¿ç”¨åœºæ™¯ | å…¨é‡éƒ¨ç½²/é‡å»º | å¢é‡æ›´æ–° |
| å‚æ•°é…ç½® | ä¸°å¯Œçš„å‚æ•°é€‰é¡¹ | è‡ªåŠ¨æ£€æµ‹å˜æ›´ |
| æ‰¹å‡†æ§åˆ¶ | æ¯ä¸ªç»„ä»¶ç‹¬ç«‹æ‰¹å‡† | æŒ‰é¡ºåºæ‰¹å‡† |

## ç›¸å…³æ–‡æ¡£

- [JENKINS-PIPELINE-SETUP.md](JENKINS-PIPELINE-SETUP.md) - Jenkins é…ç½®æŒ‡å—
- [PostCommitDeploy.Jenkinsfile](PostCommitDeploy.Jenkinsfile) - è‡ªåŠ¨éƒ¨ç½²æµæ°´çº¿
- [../playbook/*/README.md](../playbook/) - å„ç»„ä»¶éƒ¨ç½²æ–‡æ¡£

## ç»´æŠ¤æ—¥å¿—

- 2025-12-10: åˆ›å»º DeployAll æµæ°´çº¿
  - æ”¯æŒ 10 ä¸ªåŸºç¡€è®¾æ–½ç»„ä»¶
  - æ”¯æŒå¹¶è¡Œ/é¡ºåºéƒ¨ç½²æ¨¡å¼
  - æ·»åŠ å‚æ•°åŒ–é…ç½®
  - é›†æˆ SSH å‡­æ®ç®¡ç†
