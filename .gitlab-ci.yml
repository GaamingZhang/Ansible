stages:
  - detect
  - deploy

variables:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  ANSIBLE_FORCE_COLOR: "True"

# 检测哪些 playbook 被修改
detect_changes:
  stage: detect
  image: alpine:latest
  only:
    - main
  script:
    - apk add --no-cache git
    - |
      echo "Detecting changed playbooks..."
      git fetch origin
      CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
      echo "$CHANGED_FILES"
      
      # 检测各个服务的变更
      echo "DEPLOY_KUBERNETES=false" > deploy.env
      echo "DEPLOY_GITLAB=false" >> deploy.env
      echo "DEPLOY_JENKINS=false" >> deploy.env
      echo "DEPLOY_PROMETHEUS=false" >> deploy.env
      echo "DEPLOY_GRAFANA=false" >> deploy.env
      echo "DEPLOY_REDIS=false" >> deploy.env
      echo "DEPLOY_MYSQL=false" >> deploy.env
      echo "DEPLOY_MONGODB=false" >> deploy.env
      echo "DEPLOY_ELASTICSEARCH=false" >> deploy.env
      echo "DEPLOY_KAFKA=false" >> deploy.env
      
      if echo "$CHANGED_FILES" | grep -q "playbook/kubernetes/"; then
        echo "DEPLOY_KUBERNETES=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/GitLab/"; then
        echo "DEPLOY_GITLAB=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/Jenkins/"; then
        echo "DEPLOY_JENKINS=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/Prometheus/"; then
        echo "DEPLOY_PROMETHEUS=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/Grafana/"; then
        echo "DEPLOY_GRAFANA=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/Redis/"; then
        echo "DEPLOY_REDIS=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/MySQL/"; then
        echo "DEPLOY_MYSQL=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/MongoDB/"; then
        echo "DEPLOY_MONGODB=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/ElasticSearch/"; then
        echo "DEPLOY_ELASTICSEARCH=true" >> deploy.env
      fi
      if echo "$CHANGED_FILES" | grep -q "playbook/Kafka/"; then
        echo "DEPLOY_KAFKA=true" >> deploy.env
      fi
      
      cat deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
    expire_in: 1 hour

# Kubernetes 部署
deploy_kubernetes:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_KUBERNETES == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/kubernetes/deploy-k8s-cluster.yml
  timeout: 30m

# GitLab 部署
deploy_gitlab:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_GITLAB == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/GitLab/deploy-gitlab.yml
  timeout: 20m

# Jenkins 部署
deploy_jenkins:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_JENKINS == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/Jenkins/deploy-jenkins.yml
  timeout: 15m

# Prometheus 部署
deploy_prometheus:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_PROMETHEUS == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/Prometheus/deploy-prometheus.yml
    - ansible-playbook -i inventory/hosts.ini playbook/Prometheus/deploy-node-exporter-all.yml
    - ansible-playbook -i inventory/hosts.ini playbook/Prometheus/update-prometheus-config.yml
  timeout: 15m

# Grafana 部署
deploy_grafana:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_GRAFANA == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/Grafana/deploy-grafana.yml
  timeout: 10m

# Redis 部署
deploy_redis:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_REDIS == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/Redis/deploy-redis-cluster.yml
  timeout: 15m

# MySQL 部署
deploy_mysql:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_MYSQL == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/MySQL/deploy-mysql.yml
  timeout: 10m

# MongoDB 部署
deploy_mongodb:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_MONGODB == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/MongoDB/deploy-mongodb.yml
  timeout: 10m

# ElasticSearch 部署
deploy_elasticsearch:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_ELASTICSEARCH == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/ElasticSearch/deploy-elasticsearch.yml
  timeout: 15m

# Kafka 部署
deploy_kafka:
  stage: deploy
  image: alpine:latest
  only:
    - main
  needs:
    - detect_changes
  rules:
    - if: '$DEPLOY_KAFKA == "true"'
  before_script:
    - apk add --no-cache ansible openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ansible-playbook -i inventory/hosts.ini playbook/Kafka/deploy-kafka.yml
  timeout: 15m
