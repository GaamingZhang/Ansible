---
- name: 更新 Grafana 仪表板
  hosts: grafana_cluster
  become: yes
  vars:
    grafana_data_dir: "/var/lib/grafana"
  
  tasks:
    - name: 备份现有仪表板
      copy:
        src: "{{ grafana_data_dir }}/dashboards/node-exporter-dashboard.json"
        dest: "{{ grafana_data_dir }}/dashboards/node-exporter-dashboard.json.backup"
        remote_src: yes
        owner: grafana
        group: grafana
        mode: '0644'
      ignore_errors: yes

    - name: 更新节点监控仪表板
      copy:
        src: roles/install-grafana/files/node-exporter-dashboard.json
        dest: "{{ grafana_data_dir }}/dashboards/node-exporter-dashboard.json"
        owner: grafana
        group: grafana
        mode: '0644'

    - name: 重启 Grafana 服务
      systemd:
        name: grafana-server
        state: restarted

    - name: 等待 Grafana 启动
      wait_for:
        port: 3000
        delay: 5
        timeout: 60

    - name: 显示更新信息
      debug:
        msg:
          - "=========================================="
          - "Grafana 仪表板已更新！"
          - "=========================================="
          - "仪表板更新内容："
          - "  - 所有图表现在显示节点名称和IP地址"
          - "  - 格式: 节点名称 (IP:端口)"
          - "  - 确保每个节点唯一不重复"
          - "  - 仅从 all_nodes job 获取数据"
          - ""
          - "访问 Grafana:"
          - "http://{{ ansible_default_ipv4.address }}:3000"
          - ""
          - "仪表板路径: 所有节点监控概览"
          - "=========================================="
