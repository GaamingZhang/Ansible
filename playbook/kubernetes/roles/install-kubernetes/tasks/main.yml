---
# 安装 Kubernetes 组件

- name: 创建 Kubernetes 密钥目录
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: 添加 Kubernetes GPG 密钥
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  environment:
    http_proxy: "{{ http_proxy | default('') }}"
    https_proxy: "{{ https_proxy | default('') }}"

- name: 添加 Kubernetes 仓库
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /"
    state: present
    filename: kubernetes

- name: 安装 Kubernetes 组件
  apt:
    name:
      - kubelet={{ kubernetes_version }}-*
      - kubeadm={{ kubernetes_version }}-*
      - kubectl={{ kubernetes_version }}-*
    state: present
    update_cache: yes
    allow_downgrade: yes
  environment:
    http_proxy: "{{ http_proxy | default('') }}"
    https_proxy: "{{ https_proxy | default('') }}"

- name: 锁定 Kubernetes 版本
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: 配置 kubelet 环境变量
  copy:
    content: |
      KUBELET_EXTRA_ARGS=--cgroup-driver=systemd --container-runtime-endpoint=unix:///run/containerd/containerd.sock
    dest: /etc/default/kubelet

- name: 启用 kubelet
  systemd:
    name: kubelet
    enabled: yes
    state: started
  ignore_errors: yes
